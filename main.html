<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>スマホの磁気センサーで方角を取得</title>
    <style>
      #compass {
        width: 200px;
        height: 200px;
        background: url("https://takusandayo.com/geo-hunter/image.png") no-repeat center center;
        background-size: contain;
        transform-origin: center center;
        transition: transform 0.5s ease-out;
      }
    </style>
  </head>
  <body>
    <div id="direction"></div>
    <div id="compass"></div>
    <div id="location"></div>
    <div id="target"></div>
    <div id="debag1"></div>

    <button onclick="play()">Play</button>
    <button onclick="stop()">Stop</button>
    <script src="/socket.io/socket.io.js"></script>

    <script>
      const socket = io();
      let audioCtx;
      let listener;
      let panner;
      let gainNode;

      // function getDeviceOrientation() {
      //   return new Promise((resolve, reject) => {
      //     if (window.DeviceOrientationEvent) {
      //       window.addEventListener(
      //         "deviceorientation",
      //         (event) => {
      //           const alpha = (event.alpha + 90) % 360;
      //           const directionElem = document.getElementById("direction");
      //           const compassElem = document.getElementById("compass");
      //           directionElem.textContent = `方角: ${alpha.toFixed(2)}°`;
      //           compassElem.style.transform = `rotate(${alpha}deg)`;
      //           localStorage.setItem("alpha", alpha);
      //           resolve(alpha);
      //         },
      //         true
      //       );
      //     } else {
      //       alert(
      //         "このブラウザはDeviceOrientationEventをサポートしていません。"
      //       );
      //     }
      //   });
      // }
      function getDeviceOrientation() {
        return new Promise((resolve, reject) => {
          const os = detectOSSimply();
          if (os === "iphone") {
            // Safariでの許可要求
            document.querySelector("#permit").addEventListener("click", () => {
              DeviceOrientationEvent.requestPermission()
                .then((response) => {
                  if (response === "granted") {
                    window.addEventListener(
                      "deviceorientation",
                      handleOrientation
                    );
                  }
                })
                .catch((error) => console.error("Permission error:", error));
            });
          } else if (os === "android") {
            window.addEventListener(
              "deviceorientationabsolute",
              handleOrientation,
              true
            );
          } else {
            alert("PC未対応サンプル");
          }
        });
      }

      function handleOrientation(event) {
        let degrees;
        if (detectOSSimply() === "iphone") {
          degrees = event.webkitCompassHeading; // iPhone専用
        } else {
          degrees = compassHeading(event.alpha, event.beta, event.gamma); // Android用
        }

        const directionElem = document.getElementById("direction");
        const compassElem = document.getElementById("compass");
        directionElem.textContent = `方角: ${degrees.toFixed(2)}°`;
        compassElem.style.transform = `rotate(${degrees}deg)`;
        localStorage.setItem("alpha", degrees);
      }

      function compassHeading(alpha, beta, gamma) {
        const degtorad = Math.PI / 180;
        const _x = beta * degtorad || 0;
        const _y = gamma * degtorad || 0;
        const _z = alpha * degtorad || 0;

        const cX = Math.cos(_x);
        const cY = Math.cos(_y);
        const cZ = Math.cos(_z);
        const sX = Math.sin(_x);
        const sY = Math.sin(_y);
        const sZ = Math.sin(_z);

        const Vx = -cZ * sY - sZ * sX * cY;
        const Vy = -sZ * sY + cZ * sX * cY;

        let heading = Math.atan(Vx / Vy);
        if (Vy < 0) {
          heading += Math.PI;
        } else if (Vx < 0) {
          heading += 2 * Math.PI;
        }
        return heading * (180 / Math.PI);
      }

      function detectOSSimply() {
        if (navigator.userAgent.indexOf("iPhone") > 0) {
          return "iphone";
        } else if (navigator.userAgent.indexOf("Android") > 0) {
          return "android";
        } else {
          return "pc";
        }
      }
      function getGeolocation() {
        return new Promise((resolve, reject) => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const crd = position.coords;
                const locationElem = document.getElementById("location");
                locationElem.textContent = `緯度: ${crd.latitude}, 経度: ${crd.longitude}`;
                localStorage.setItem("latitude", crd.latitude);
                localStorage.setItem("longitude", crd.longitude);
                socket.emit("map", {
                  name: localStorage.getItem("userName"),
                  lat: crd.latitude,
                  lng: crd.longitude,
                });
                resolve({ latitude: crd.latitude, longitude: crd.longitude });
              },
              (error) => {
                reject(error);
              }
            );
          } else {
            alert("このブラウザはGeolocation APIをサポートしていません。");
          }
        });
      }

      const restart = () => {
        var alpha = 0;
        var latitude = 0;
        var longitude = 0;
        getDeviceOrientation()
          .then((alpha) => {
            console.log(`Device orientation: ${alpha}`);
            alpha = alpha;
          })
          .catch((error) => {
            console.error(error);
          });
        getGeolocation()
          .then((coords) => {
            console.log(
              `Geolocation: 緯度 ${coords.latitude}, 経度 ${coords.longitude}`
            );
            latitude = coords.latitude;
            longitude = coords.longitude;
          })
          .catch((error) => {
            console.error(error);
          });
        var targetX = 0;
        var targetY = 0;
        latitude = targetY - localStorage.getItem("latitude");
        longitude = targetX - localStorage.getItem("longitude");
        alpha = localStorage.getItem("alpha");
        document.getElementById(
          "debag1"
        ).textContent = `latitude: ${latitude}, longitude: ${longitude}, alpha: ${alpha}`;

        const radians = Math.atan2(latitude, longitude); //NOTE: atanは0<=x<=π/2の範囲でしか返さない
        let degrees = radians * (180 / Math.PI);

        // degreesを0度から360度の範囲に変換
        if (degrees < 0) {
          degrees += 360;
        }

        const target = document.getElementById("target");
        target.textContent = `radians: ${radians}, degrees: ${degrees}, time: ${new Date().toLocaleTimeString()}`;

        if (degrees - 10 <= alpha && alpha <= degrees + 10) {
          if (degrees - 2 <= alpha && alpha <= degrees + 2) {
            just_play();
            updatePosition(panner, 0, 0, 0); // 通常の音声
          }
          play();
          updatePosition(panner, 0, 0, 0); // 通常の音声
        } else if (degrees < alpha) {
          play();
          updatePosition(panner, -10, 0, 0); // 左から音声
        } else {
          play();
          updatePosition(panner, 10, 0, 0); // 右から音声
        }
        setTimeout(() => {
          restart();
        }, 5000);
      };
      restart();

      //NOTE: 立体音響の実装
      function setupListener() {
        const posX = window.innerWidth / 2;
        const posY = window.innerHeight / 2;
        const posZ = 300;

        if (listener.positionX) {
          listener.positionX.value = posX;
          listener.positionY.value = posY;
          listener.positionZ.value = posZ;
        } else {
          listener.setPosition(posX, posY, posZ);
        }

        if (listener.forwardX) {
          listener.forwardX.value = 0;
          listener.forwardY.value = 0;
          listener.forwardZ.value = -1;
          listener.upX.value = 0;
          listener.upY.value = 1;
          listener.upZ.value = 0;
        } else {
          listener.setOrientation(0, 0, -1, 0, 1, 0);
        }
      }

      function createPanner(posX, posY, posZ) {
        return new PannerNode(audioCtx, {
          panningModel: "HRTF", // より現実的な3D音響効果
          distanceModel: "linear", // 距離による音量減衰の計算方法
          positionX: posX,
          positionY: posY,
          positionZ: posZ,
          orientationX: 0.0,
          orientationY: 0.0,
          orientationZ: -1.0,
          refDistance: 1, // 基準距離
          maxDistance: 20000, // 最大距離
          rolloffFactor: 10, // 距離による音量減衰率
          coneInnerAngle: 40, // 内部コーンの角度
          coneOuterAngle: 50, // 外部コーンの角度
          coneOuterGain: 0.4, // 外部コーンでの音量
        });
      }

      function setupAudio(audioElement) {
        const track = new MediaElementAudioSourceNode(audioCtx, {
          mediaElement: audioElement,
        });

        panner = createPanner(
          window.innerWidth / 2,
          window.innerHeight / 2,
          300
        );
        gainNode = audioCtx.createGain();
        track.connect(panner).connect(gainNode).connect(audioCtx.destination);
      }

      function updatePosition(panner, x, y, z) {
        panner.positionX.value = panner.positionX.value + x;
        panner.positionY.value = panner.positionY.value + y;
        panner.positionZ.value = panner.positionZ.value + z;
      }
      function setVolume(value) {
        gainNode.gain.value = value;
      }
      function just_play() {
        const audioElement = new Audio("/Audio/just_music.mp3");
        setupListener();
        setupAudio(audioElement);
        audioElement.play();
      }
      function play() {
        audioCtx = new AudioContext();
        listener = audioCtx.listener;
        const audioElement = new Audio("/Audio/music.mp3");
        setupListener();
        setupAudio(audioElement);
        audioElement.play();
      }
      function stop() {
        if (audioCtx && audioCtx.state !== "closed") {
          audioCtx.close().then(() => {
            audioCtx = null;
            panner = null;
            gainNode = null;
          });
        }
      }
    </script>
  </body>
</html>
